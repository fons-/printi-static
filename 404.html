<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no"/>
	<title>printi</title>
	<meta charset="utf-8" />
	<script>console.log("printi, by Fons van der Plas (http://github.com/fons-) ðŸŒˆ");</script>
	<meta name="theme-color" content="#FFEFEF"/>
	<meta name="description" content="Send your pictures to the world's fastest photo printer!"/>
	<link href="https://fonts.googleapis.com/css?family=Courgette|Itim" rel="stylesheet">
	<style>
		body {
			background-color: #ffe3e3;
			margin: 0px;
		}

		main, footer {
			margin: 0 auto;
			width: 250px;
			align-content: center;
			text-align: center;
		}

		#titlecontainer {
			letter-spacing: 3px;
			background-color: #ffefef;
			font-family: 'Courgette', sans-serif;
			width: 100%;
			overflow: hidden;
		}

		#logocontainer {
			margin: 0 auto;
			width: 250px;
			height: 80px;
			padding-top: 30px;
			padding-bottom: 20px;
			align-content: center;
			text-align: center;
		}

		#logocontainer img {
			margin-bottom: -8px;
		}

		#logocontainer h1 {
			margin-top: 10px;
		}

		.titlesecret {
			background-color: rgba(255, 255, 255, .75);
			width: 100%;
			align-content: center;
			text-align: center;
			font-size: 40px;
			cursor: pointer;

			overflow: hidden;
		}
		#cameracontainer{
			max-height: 0px;

			transition: max-height 500ms;
			-webkit-transition: max-height 500ms;
		}
		#printicambuttoncontainer{
			height: 0px;

			transition: height 500ms;
			-webkit-transition: height 500ms;
		}
		.showcamera{
			max-height: 500px !important;
		}

		.showprinticambutton {
			height: 80px !important;
		}

		#printernametitle{
			position: absolute;
			white-space: nowrap;
			font-weight: normal;
			opacity: .6;
		}

		.receiptcontainer {
			overflow: hidden;
		}

		.receiptpadder {
			padding-top: 20px;
			/*
				--Timing--
				Printer speed: 4.5 inch per second = 114.3 mm/s
				Receipt width: 80 mm or 250 px
				=> Printer speed: 114.3 * 250 / 80 = 357.1875 px/s
				Transition distance: 1000px
				=> Transition duration: 1000 / 357.1875 = 2.8 s
			*/
			transition: margin 2800ms;
			-webkit-transition: margin 2800ms;
			transition-timing-function: linear;
			-webkit-transition-timing-function: linear;
		}

		.receiptbackground {
			padding: 12px;
			border: 5px solid white;
			background-color: white;
		}

		#curtain {
			transition: 200ms linear left;
			position: absolute;
			right: 0px;
			top: 0px;
			height: 100%;
			width: 0%;
			background-color: rgba(255, 255, 255, 0.8);
		}

		.previewimg {
			max-width: 100%;
			height: auto;
			transition: 500ms filter linear;
			-webkit-transition: 500ms -webkit-filter linear;
		}

		#formcontainer {
			overflow-x: hidden;
		}

		footer {
			text-decoration: underline;
			font-family: monospace;
			font-style: italic;
			margin-top: 400px;
			padding-bottom: 50px;
		}

		footer a {
			color: black;
			opacity: .6;
		}

		.printed {
			margin-top: -1000px!important;
		}

		.bwfilter {
			filter: grayscale(100%);
			-webkit-filter: grayscale(100%);
		}

		.wiggler {
			animation: wiggle 200ms;
			animation-iteration-count: infinite;
			-webkit-animation: wiggle 200ms;
			-webkit-animation-iteration-count: infinite;
		}

		@keyframes fadeout {
			0% {
				opacity: .6;
			}
			50% {opacity: .6; }
			100% {opacity: 0; }
		}

		@keyframes wiggle {
			0% { transform: rotate(0deg); }
			25% { transform: rotate(-1deg); }
			50% { transform: rotate(0deg); }
			75% { transform: rotate(1deg); }
			100% { transform: rotate(0deg); }
		}

		.printicamrotator{
			font-family: monospace;
			text-decoration: underline;
			font-size: 15px;
			margin: auto;
			padding-top: 10px;
			overflow: hidden;
			letter-spacing: .3ex;
		}

		.printicamtext{
			animation: moveleft 1500ms linear;
			animation-iteration-count: infinite;
		}

		#videoscreen {
			width: 250px;
			margin: auto;
			background-color: white;
			padding-top: 12px;
		}

		video {
			width: 226px;
			pointer-events: none;
		}

		.takepicture{
			animation: pictureflash 200ms linear;
		}


		@keyframes moveleft {
			0% { margin-left: 0ex; }
			100% { margin-left: -100%; }
		}

		@keyframes pictureflash {
			0% {
				filter: grayscale(1.0) contrast(2.0);
			}
			100% {
				filter: grayscale(0.0) contrast(1.0);
			}
		}
	</style>
</head>
<body>
	<header id="titlecontainer">
		<div id="logocontainer">
			<h1><img src="Content/printi_logo_transparent.svg" width="100" height="34" alt="printi" title="printi" /><span id="printernametitle"></span></h1>
		</div>
		<div id="cameracontainer" class="titlesecret">
			<div id="videoscreen">
				<video playsinline autoplay></video>
			</div>
		</div>
		<div id="printicambuttoncontainer" class="titlesecret">
		<div class="printicamrotator" style="width: 8.4ex; transform: rotate(-15deg) translate(-17px, 12px);"><div class="printicamtext" style="animation-duration: 3000ms;">printiprintiprintiprinti</div></div>
		<div class="printicamrotator" style="width: 4.2ex; transform: rotate(-15deg) translate(23px, 7px);"><div class="printicamtext">camcamcamcam</div></div>
	</div>
	</header>

	<main id="receiptstack">
		<span style="display: none" id="receiptprototype">
			<div class="receiptcontainer">
				<div class="receiptpadder">
					<div class="receiptbackground">
						<div class="preview">
							<img class="previewimg" src="#" width="250" />
							<div id="curtain"></div>
						</div>
					</div>
				</div>
			</div>
		</span>

		<div class="receiptcontainer">
			<div class="receiptpadder" id="receiptupload">
				<div class="receiptbackground">
					<div id="formcontainer">
						<form id="leform" action="" method="post" enctype="multipart/form-data" target="responseframe">
							<input id="filepicker" type="file" name="theshiz" accept="image/*">
							<!--<br /><br />
				<input type="submit">-->
						</form>
					</div>
				</div>
			</div>
		</div>
		<span id="logje"></span>
		<iframe name="responseframe" style="display: none;"></iframe>
	</main>

	<footer>
			<a href="https://github.com/fons-/printi/blob/master/README.md">What is printi?</a>
		</footer>


	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script>
		if(document.location.pathname != "/"){
			$("#printernametitle").text(decodeURI(document.location.pathname))
		}
		$(document).ready(function () {
			if(window.location.search.indexOf("log") != -1)
			{
				if (typeof console != "undefined")
					if (typeof console.log != 'undefined')
						console.olog = console.log;
					else
						console.olog = function () { };

				console.log = function (message) {
					console.olog(message);
					$('#logje').prepend('<p>' + message + '</p>');
				};
				console.error = console.debug = console.info = console.log;
			}

			var video = document.querySelector("video");
			window.video = video;

			sourceToDataUri = function(source, width, height){
				var canvas = document.createElement("canvas"); // (will not be displayed)

				var PAGEWIDTH = document.location.pathname == "/" ? 576 : 384; // 576 for printi classic, 384 for printi mini
				var vert = height > width;
				var minorlength = vert ? width : height;

				var newWidth = 0;
				var newHeight = 0;

				if(minorlength < PAGEWIDTH){
					newWidth = width;
					newHeight = height;
				} else {
					var ratio = PAGEWIDTH / minorlength;
					newWidth = vert ? PAGEWIDTH : ratio * width;
					newHeight = vert ? ratio * height : PAGEWIDTH;
				}

				canvas.width = newWidth;
				canvas.height = newHeight;
				var ctx = canvas.getContext("2d");
				ctx.drawImage(source, 0, 0, newWidth, newHeight);

				console.log(canvas);
				console.log(canvas.width);
				console.log(canvas.height);

				// render image to a jpeg (data URI) at 70% compression quality
				var datayumyum = canvas.toDataURL("image/jpeg", .7);

				// strip header from data URI
				var base64data = datayumyum.split(',')[1];

				//TODO: destroy canvas?
				return {
					dataURL: datayumyum,
					base64data: base64data,
				};
			};

			startUpload = function () {
				var receiptElements = [];

				var xhr = new XMLHttpRequest();
				xhr.upload.onprogress = function (e) {
					console.log(e);
					var reverseprogress = ((e.total - e.loaded) / e.total) * 100;


					for(var i = 0; i < receiptElements.length; i++){
						var receiptEl = receiptElements[i];
						$(receiptEl).find("#curtain").attr("style", "width: " + reverseprogress + "%;");
						if (reverseprogress < 5 && !$(receiptEl).hasClass("wiggler")) {
							$(receiptEl).addClass("wiggler");
						}
					}

				};
				xhr.onload = function (e) {
					console.log(e);
					for(var i = 0; i < receiptElements.length; i++){
						var receiptEl = receiptElements[i];
						$(receiptEl).find("#curtain").attr("style", "width: 0%;");
						$(receiptEl).find(".previewimg").addClass("bwfilter");
						setTimeout(function () {
							$(receiptEl).removeClass("wiggler");
							$(receiptEl).find(".receiptpadder").addClass("printed");
							setTimeout(function () {
								//TODO: remove el
								$(receiptEl).remove()
							}, 2000);
						}, 1000);
					}
				};

				xhr.open('POST', 'https://api.printi.me/submitimages'+document.location.pathname, true);

				var ua = window.navigator.userAgent;
				var ie = (ua.indexOf('MSIE ') + ua.indexOf('Trident/') + ua.indexOf('Edge/') > -3);

				var allimages = true;

				var added = 0;
				var toAdd = this.files.length;

				if(!('printicamvideo' in this)){
					for (var i = 0; i < this.files.length; i++) {
						allimages = allimages && this.files[i].type.match("image.*");
					}
				}

				console.log("added: " + added);
				console.log("toAdd: " + toAdd);

				var filereadersupport = 'FileReader' in window;

				if (!ie && allimages && filereadersupport) {
					var base64images = []; // will contain base64 encoded, compressed images
					for (var i = 0; i < this.files.length; i++) {

						var receiptEl = $("#receiptprototype")[0].children[0].cloneNode(true);//TODO

						$("#receiptstack")[0].prepend(receiptEl)
						receiptElements.push(receiptEl)

						if("printicamvideo" in this)
						{
							// in this case, we are not dealing with a file upload, but with a printi cam video snapshot
							var result = sourceToDataUri(this.printicamvideo, this.printicamvideo.videoWidth, this.printicamvideo.videoHeight);

							$(receiptEl).find(".previewimg").attr("src", result.dataURL);

							base64images.push(result.base64data);
							added += 1;
							if (added == toAdd) {
								console.log("sending...");
								xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
								xhr.send(JSON.stringify({ images: base64images }));
							}

						} else {

							var file = this.files[i];
							console.log(file);

							var reader = new FileReader();
							reader.onload = function (e) {
								$(receiptEl).find(".previewimg").attr("src", e.target.result);
								$(receiptEl).find(".preview").attr("style", "display: block;");
								//$("#formcontainer").attr("style", "display: none;");

								var immie = document.createElement("img"); // (will not be displayed)

								immie.onload = function () {
									console.log("immie loaded:");
									console.log(immie.width);
									console.log(immie.height);

									var result = sourceToDataUri(immie, immie.width, immie.height);

									base64images.push(result.base64data);
									added += 1;
									if (added == toAdd) {
										console.log("sending...");
										xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
										xhr.send(JSON.stringify({ images: base64images }));
									}
								};
								// setting the image source starts the loading process
								immie.src = e.target.result;
							}
							reader.readAsDataURL(file);

						}
					}
				} else {
					console.log("not downsizing; sending raw files...");
					var data = new FormData();
					for (var i = 0; i < this.files.length; i++) {
						data.append('file' + i, this.files[i]);
						added += 1; if (added == toAdd) { xhr.send(data); }
					}
				}
			};

			window.cameraConnected = false;

			document.getElementById("logocontainer").onclick = function (){
				if(window.cameraConnected){
					var cl = document.getElementById("cameracontainer").classList;
					if(cl.contains("showcamera")){
						setTimeout(function () {
							window.stream.getTracks()[0].stop();
							window.cameraConnected = false;
							video.srcObject = null;
						}, 500);

					}
					cl.toggle("showcamera");
				} else {
					document.getElementById("printicambuttoncontainer").classList.toggle("showprinticambutton");
				}
			};

			document.getElementById("printicambuttoncontainer").onclick = function (){
				navigator.mediaDevices.getUserMedia({audio: false, video: {
					facingMode: "environment",
				},}).then(function (stream){

					window.stream = stream;
					video.srcObject = stream;
					window.cameraConnected = true;
					video.controls = false;
					video.play();
					video.controls = false;

					document.getElementById("printicambuttoncontainer").classList.remove("showprinticambutton");
					document.getElementById("cameracontainer").classList.add("showcamera");
				}).catch(function(error){
					console.log(error);
					window.cameraConnected = false;
				});
			};

			document.onvisibilitychange = function (){
				if(window.cameraConnected){
					if(document.visibilityState != "visible"){
						window.stream.getTracks()[0].stop();
						window.cameraConnected = false;
						video.srcObject = null;

						document.getElementById("printicambuttoncontainer").classList.add("showprinticambutton");
						document.getElementById("cameracontainer").classList.remove("showcamera");
					}
				}
			};

			document.getElementById("cameracontainer").onclick = function (){
				var cl = video.classList;
				cl.remove("takepicture");
				void video.offsetHeight;
				cl.add("takepicture");
				video.play();
				video.controls = false;

				startUpload.call({
					files: [null],
					printicamvideo: video,
				});
			};

			document.getElementById("filepicker").onchange = function () {
				startUpload.call(this);
			};

			document.addEventListener('paste', function (e) {
				if (e.clipboardData) {
					var items = e.clipboardData.items;
					var imagesPasted = false;
					// if an image is pasted, convert it to a file and add it to the (fake) this.files list
					// then pass `this` to the startUpload function.
					this.files = [];
					for (var i = 0; i < items.length; i++) {
						if (items[i].type.indexOf("image") >= 0) {
							imagesPasted = true;
							var blob = items[i].getAsFile();
							this.files.push(blob);
						}
						console.log(items[i].type)
						if (items[i].type.indexOf("text") >= 0) {
							items[i].getAsString(function (s) {

								var xhr = new XMLHttpRequest();
								xhr.open('POST', 'https://url.printi.me/api/url/printi', true);
								xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
								xhr.send(JSON.stringify({ url: s }));

								$(".preview").attr("style", "display: block;");
								$("#formcontainer").attr("style", "dvisplay: none;");
							});
						}
					}
					if (imagesPasted) {
						startUpload.call(this);
					}
					e.preventDefault();
				}
			}, false);
		});

	</script>
	<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</body>
</html>
